<?php

use app\models\elo\aftersales\mBukuBesar;
use app\models\elo\aftersales\mWorkOrder;
use app\models\elo\kmg\ModelKaryawan;
use app\models\elo\kmg\ModelPerusahaan;
use Carbon\Carbon;

if (!defined('BASEPATH')) exit('No direct script access allowed');


class Model_report extends CI_Model
{

    public function getCabang()
    {
        $query  = ModelPerusahaan::whereId_brand(5)->get();
        $cabang = array();
        foreach ($query as $value) {
            $cabang[] = [
                'id' => encrypter($value['id_perusahaan']),
                'text' => $value['singkat'] . ' - ' . $value['lokasi']
            ];
        }

        return responseJson(compact('cabang'));
    }

    public function lihat_data_pembelian_sparepart($id_perusahaan, $tgl_awal, $tgl_akhir)
    {
        $data = $this->db_wuling_sp->query("SELECT imd.id_item_masuk, imd.kode_item, imd.id_pesanan_pembelian, imd.total_item_item_masuk, im.no_invoice, im.tanggal_invoice, im.tanggal_item_masuk, im.kode_supplier, s.kode, s.nama_supplier, i.part_number, i.nama_item, pe.harga_tebus_dpp, pe.diskon, pe.total, kp.nama_kategori FROM item_masuk_detail AS imd LEFT JOIN item AS i ON i.kode_item = imd.kode_item LEFT JOIN item_masuk AS im ON im.id_item_masuk = imd.id_item_masuk LEFT JOIN supplier AS s ON s.kode_supplier = im.kode_supplier LEFT JOIN pembelian AS pe ON pe.id_pesanan_pembelian = imd.id_pesanan_pembelian AND pe.kode_item = imd.kode_item LEFT JOIN pesanan_pembelian AS pp ON pp.id_pesanan_pembelian = imd.id_pesanan_pembelian LEFT JOIN kategori_pembelian AS kp ON kp.kode_kategori_pembelian = pp.kategori WHERE im.id_perusahaan = '$id_perusahaan' AND im.tanggal_invoice BETWEEN '$tgl_awal' AND '$tgl_akhir' ORDER BY im.no_invoice, im.tanggal_invoice ASC");
        return $data;
    }

    public function get_data_laporan_pesanan_pembelian($id_perusahaan, $tgl_awal, $tgl_akhir)
    {
        $result = $this->db_wuling_sp->query("SELECT pp.id_pesanan_pembelian, pp.no_po, pp.no_order_id, pp.tanggal, pp.keterangan, pp.total_item, pp.total_akhir, pp.jt, pp.diskon, pp.diskon_rp, pp.bayar, pp.kredit_a, pp.kredit_o, pp.subtotal, pp.`status`,	pp.status_retur, pp.pajak, pp.pajak_rp, pp.cetak_invoice, pp.tanggal_lunas, pp.admin, s.nama_supplier, kp.nama_kategori FROM pesanan_pembelian AS pp LEFT JOIN supplier AS s ON pp.kode_supplier = s.kode_supplier LEFT JOIN kategori_pembelian AS kp ON pp.kategori = kp.kode_kategori_pembelian WHERE pp.id_perusahaan = '$id_perusahaan' AND pp.batal_transaksi = '0' AND pp.w_insert BETWEEN '$tgl_awal 00:00:00' AND '$tgl_akhir 00:00:00'");
        return $result;
    }

    public function get_data_pembelian($id_pesanan_pembelian)
    {
        $result = $this->db_wuling_sp->query("SELECT p.id_pembelian, p.id_pesanan_pembelian, p.harga_tebus_dpp, p.harga_highest, p.harga_price_variance, p.ppn, p.jumlah_o, p.jumlah, (SELECT SUM(imd.total_item_item_masuk) FROM item_masuk_detail AS imd WHERE imd.kode_item = p.kode_item AND imd.id_pesanan_pembelian = p.id_pesanan_pembelian ) AS masuk, p.jumlah_c, p.diskon, p.diskon_rp, p.total, p.kurang, p.status_om, p.id_perusahaan, p.users, p.keterangan, p.note, i.kode_item, i.part_number, i.jenis_item, i.tipe_item, i.nama_item, i.het_now, i.ongkos_kirim, i.class_item, i.kode_satuan, i.tipe, i.ukuran, i.merek, i.kode_kategori FROM pembelian AS p LEFT JOIN item AS i ON p.kode_item = i.kode_item WHERE p.id_pesanan_pembelian = '$id_pesanan_pembelian'");
        return $result;
    }

    public function get_data_service($id_perusahaan, $tgl_awal, $tgl_akhir)
    {
        $result = $this->db_wuling_as->query("SELECT wdp.kode_item, c.nama, duc.no_polisi, k.nama_karyawan, i.part_number, i.nama_item, i.tipe_item AS id_p_type_item, wo.no_wo, wo.tgl_service, a.no_invoice, a.invoice_date, wdp.claim, wdp.qty, wdp.harga_jual, wdp.diskon, wdp.diskon_rp, wdp.total FROM work_order AS wo LEFT JOIN( SELECT DISTINCT ias.no_invoice, ias.no_ref, ias.invoice_date, ias.invoice_batal, nef.no_e_faktur FROM db_wuling_as.invoice_after_sales AS ias LEFT JOIN db_wuling.nomor_e_faktur AS nef ON ias.no_invoice = nef.no_transaksi WHERE ias.invoice_batal != '1' AND(( ias.no_invoice LIKE 'INV-WO%' OR ias.no_invoice LIKE 'INV.WO%') AND ias.no_invoice NOT LIKE 'INV-WO-CLM%')) AS a ON a.no_ref = wo.no_wo LEFT JOIN wo_detail_part AS wdp ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_sp.item AS i ON i.kode_item = wdp.kode_item LEFT JOIN customer AS c ON c.id_customer = wo.id_customer LEFT JOIN kmg.karyawan AS k ON k.nik = wo.`user` LEFT JOIN detail_unit_customer AS duc ON duc.no_rangka = wo.no_rangka WHERE wo.id_perusahaan = '$id_perusahaan' AND wdp.s_request = '2' AND wdp.del = '0' AND wo.closed = '1' AND wo.batal_wo = '0' AND a.invoice_batal != '1' AND( DATE( a.invoice_date) BETWEEN '$tgl_awal' AND '$tgl_akhir' ) ORDER BY a.invoice_date ASC");
        return $result;
    }

    public function get_data_part_counter($id_perusahaan, $tgl_awal, $tgl_akhir)
    {
        $result = $this->db_wuling_sp->query("SELECT pp.id_perusahaan, a.no_invoice, a.tgl_invoice, a.invoice_batal, pp.no_transaksi, pp.tgl, pp.batal_transaksi, p.kode_item, i.part_number, i.nama_item, p.qty, p.harga_jual, u.nama_lengkap, pp.diskon, pp.ongkir_rp, IFNULL( c.id_customer, pe.kode_pelanggan) AS kode_pelanggan, IFNULL( c.nama, pe.nama_pelanggan) AS nama_pelanggan FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON pp.id_pesanan_penjualan = p.id_pesanan_penjualan LEFT JOIN item AS i ON i.kode_item = p.kode_item LEFT JOIN pelanggan AS pe ON pe.kode_pelanggan = pp.kode_pelanggan LEFT JOIN group_pelanggan AS gp ON gp.kode_group_pelanggan = pe.kode_group_pelanggan LEFT JOIN db_wuling_as.customer AS c ON c.id_customer = pp.kode_pelanggan LEFT JOIN db_wuling.users AS u ON u.nik = pp.kode_sales LEFT JOIN( SELECT DISTINCT ias.no_invoice, DATE( ias.invoice_date) AS tgl_invoice, ias.no_ref AS no_transaksi, ias.invoice_batal, nef.no_e_faktur FROM db_wuling_as.invoice_after_sales AS ias LEFT JOIN db_wuling.nomor_e_faktur AS nef ON ias.no_invoice = nef.no_transaksi WHERE ias.no_invoice LIKE 'INV-PC.%' ) AS a ON a.no_transaksi = pp.no_transaksi WHERE pp.id_perusahaan = '$id_perusahaan' AND pp.batal_transaksi = '0' AND a.invoice_batal = '0' AND a.no_invoice IS NOT NULL AND a.tgl_invoice BETWEEN '$tgl_awal' AND '$tgl_akhir' ORDER BY a.tgl_invoice ASC");
        return $result;
    }

    public function getStokCurrentRegulerClosingDate($id_perusahaan, $tgl_awal, $tgl_awal_bulan, $tgl_akhir_bulan = null)
    {
        $result = $this->db_wuling_sp->query("SELECT reg.id_perusahaan, reg.kode_item, reg.part_number, reg.nama_item, mi.het_now AS harga_jual, mi.class_item, IFNULL( a.stok_masuk, 0) AS masuk_pembelian, IFNULL( b.stok_ditemukan, 0) AS masuk_ditemukan, IFNULL( c.stok_masuk, 0) AS masuk_retur_sparepart, IFNULL( d.stok_masuk, 0) AS masuk_retur_service, IFNULL( e.stok_hilang, 0 ) AS keluar_hilang, IFNULL( f.stok_keluar, 0 ) AS keluar_service_new, IFNULL( g.stok_keluar, 0 ) AS keluar_service_old, IFNULL( h.stok_keluar, 0 ) AS keluar_service_retur, IFNULL( i.stok_keluar, 0 ) AS keluar_sparepart, IFNULL( j.stok_keluar, 0 ) AS keluar_sparepart_retur, IFNULL( k.stok_alokasi, 0 ) AS alokasi_sparepart, IFNULL( l.stok_alokasi, 0 ) AS alokasi_service, IFNULL( m.stok_wip, 0 ) AS wip_sparepart, IFNULL( n.stok_wip, 0 ) AS wip_service, IFNULL( o.stok_masuk, 0 ) AS masuk_mutasi_stok, IFNULL( p.stok_keluar, 0 ) AS keluar_mutasi_stok, stock_in.stok_in, stock_out.stok_out, trans_in.trans_in, trans_out.trans_out FROM stok_all_in_reg AS reg LEFT JOIN item AS mi ON mi.kode_item = reg.kode_item LEFT JOIN( SELECT pp.id_perusahaan, imdd.kode_item, SUM( imdd.total_item_item_masuk ) AS stok_masuk FROM item_masuk_detail AS imdd LEFT JOIN pesanan_pembelian AS pp ON imdd.id_pesanan_pembelian = pp.id_pesanan_pembelian LEFT JOIN item_masuk AS imm ON imdd.id_item_masuk = imm.id_item_masuk WHERE pp.batal_transaksi = '0' AND imm.tanggal_item_masuk BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY imdd.kode_item, pp.id_perusahaan ) a ON a.kode_item = reg.kode_item AND a.id_perusahaan = reg.id_perusahaan LEFT JOIN( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_ditemukan FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = reg.kode_item AND b.id_perusahaan = reg.id_perusahaan LEFT JOIN( SELECT pp.id_perusahaan, p.kode_item AS kode_item, SUM( p.qty ) AS stok_masuk FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) c ON c.kode_item = reg.kode_item AND c.id_perusahaan = reg.id_perusahaan LEFT JOIN( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_masuk FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = reg.kode_item AND d.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_hilang FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) e ON e.kode_item = reg.kode_item AND e.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) f ON f.kode_item = reg.kode_item AND f.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) g ON g.kode_item = reg.kode_item AND g.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) h ON h.kode_item = reg.kode_item AND h.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item, SUM( p.qty ) AS stok_keluar FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref WHERE pp.batal_transaksi = '0' AND pp.cetak_invoice = '1' AND pp.status_penjualan = 'penjualan' AND ias.invoice_batal = '0' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) i ON i.kode_item = reg.kode_item AND i.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item AS kode_item, SUM( p.qty ) AS stok_keluar FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) j ON j.kode_item = reg.kode_item AND j.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item, SUM( p.qty ) AS stok_alokasi FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan WHERE pp.batal_transaksi = '0' AND pp.status_keluar = '0' AND pp.cetak_invoice != '1' AND pp.status_penjualan = 'penjualan' AND pp.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan UNION SELECT pp.id_perusahaan, p.kode_item, SUM( p.qty ) AS stok_alokasi FROM pesanan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan WHERE pp.batal_transaksi = '0' AND pp.status_keluar = '0' AND pp.cetak_invoice != '1' AND pp.status_penjualan = 'pesanan' AND p.id_gudang_lokasi IS NOT NULL AND pp.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) k ON k.kode_item = reg.kode_item AND k.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item, SUM( wdp.qty ) AS stok_alokasi FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request != '2' AND wo.cetak_invoice != 'y' AND wo.tgl_service BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) l ON l.kode_item = reg.kode_item AND l.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item, SUM( p.qty ) AS stok_wip FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan WHERE pp.batal_transaksi = '0' AND pp.status_keluar = '1' AND pp.cetak_invoice != '1' AND pp.status_penjualan = 'penjualan' AND pp.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) m ON m.kode_item = reg.kode_item AND m.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item, SUM( wdp.qty ) AS stok_wip FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice != 'y' AND wo.tgl_service BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) n ON n.kode_item = reg.kode_item AND n.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, sum( msmd.stok_item_masuk ) AS stok_masuk FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS o ON o.kode_item = reg.kode_item AND o.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, SUM( msdk.stok_keluar ) AS stok_keluar FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS p ON p.kode_item = reg.kode_item AND p.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT reg.id_perusahaan, reg.kode_item, ( IFNULL( a.stok_masuk, 0 ) + IFNULL( b.stok_ditemukan, 0 ) + IFNULL( c.stok_masuk, 0 ) + IFNULL( d.stok_masuk, 0 ) + IFNULL( e.stok_masuk, 0 )) AS stok_in FROM stok_all_in_reg AS reg LEFT JOIN item AS mi ON mi.kode_item = reg.kode_item LEFT JOIN ( SELECT pp.id_perusahaan, imdd.kode_item, SUM( imdd.total_item_item_masuk ) AS stok_masuk FROM item_masuk_detail AS imdd LEFT JOIN pesanan_pembelian AS pp ON imdd.id_pesanan_pembelian = pp.id_pesanan_pembelian LEFT JOIN item_masuk AS imm ON imdd.id_item_masuk = imm.id_item_masuk WHERE pp.batal_transaksi = '0' AND imm.tanggal_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY imdd.kode_item, pp.id_perusahaan ) a ON a.kode_item = reg.kode_item AND a.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_ditemukan FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = reg.kode_item AND b.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item AS kode_item, SUM( p.qty ) AS stok_masuk FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) c ON c.kode_item = reg.kode_item AND c.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_masuk FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = reg.kode_item AND d.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, sum( msmd.stok_item_masuk ) AS stok_masuk FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS e ON e.kode_item = reg.kode_item AND e.id_perusahaan = reg.id_perusahaan WHERE reg.tipe_item = '1' AND reg.id_perusahaan = '$id_perusahaan' ) AS stock_in ON stock_in.kode_item = reg.kode_item AND stock_in.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT reg.id_perusahaan, reg.kode_item, ( IFNULL( a.stok_hilang, 0 ) + IFNULL( b.stok_keluar, 0 ) + IFNULL( c.stok_keluar, 0 ) + IFNULL( d.stok_keluar, 0 ) + IFNULL( e.stok_keluar, 0 ) + IFNULL( f.stok_keluar, 0 ) + IFNULL( g.stok_keluar, 0 )) AS stok_out FROM stok_all_in_reg AS reg LEFT JOIN item AS mi ON mi.kode_item = reg.kode_item LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_hilang FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) a ON a.kode_item = reg.kode_item AND a.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) b ON b.kode_item = reg.kode_item AND b.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = reg.kode_item AND c.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = reg.kode_item AND d.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item, SUM( p.qty ) AS stok_keluar FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref WHERE pp.batal_transaksi = '0' AND pp.cetak_invoice = '1' AND pp.status_penjualan = 'penjualan' AND ias.invoice_batal = '0' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) e ON e.kode_item = reg.kode_item AND e.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item AS kode_item, SUM( p.qty ) AS stok_keluar FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) f ON f.kode_item = reg.kode_item AND f.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, SUM( msdk.stok_keluar ) AS stok_keluar FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS g ON g.kode_item = reg.kode_item AND g.id_perusahaan = reg.id_perusahaan WHERE reg.tipe_item = '1' AND reg.id_perusahaan = '$id_perusahaan' ) AS stock_out ON stock_out.kode_item = reg.kode_item AND stock_out.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT reg.id_perusahaan, reg.kode_item, ( IFNULL( a.trans_in, 0 ) + IFNULL( b.trans_in, 0 ) + IFNULL( c.trans_in, 0 ) + IFNULL( d.trans_in, 0 ) + IFNULL( e.trans_in, 0 )) AS trans_in FROM stok_all_in_reg AS reg LEFT JOIN item AS mi ON mi.kode_item = reg.kode_item LEFT JOIN ( SELECT pp.id_perusahaan, imdd.kode_item, COUNT( imm.no_invoice ) AS trans_in FROM item_masuk_detail AS imdd LEFT JOIN pesanan_pembelian AS pp ON imdd.id_pesanan_pembelian = pp.id_pesanan_pembelian LEFT JOIN item_masuk AS imm ON imdd.id_item_masuk = imm.id_item_masuk WHERE pp.batal_transaksi = '0' AND imm.tanggal_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY imdd.kode_item, pp.id_perusahaan ) a ON a.kode_item = reg.kode_item AND a.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, COUNT( b.no_transaksi ) AS trans_in FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = reg.kode_item AND b.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item AS kode_item, COUNT( pp.no_transaksi ) AS trans_in FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) c ON c.kode_item = reg.kode_item AND c.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_in FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = reg.kode_item AND d.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, COUNT( msm.no_transaksi ) AS trans_in FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS e ON e.kode_item = reg.kode_item AND e.id_perusahaan = reg.id_perusahaan WHERE reg.tipe_item = '1' AND reg.id_perusahaan = '$id_perusahaan' ) AS trans_in ON trans_in.kode_item = reg.kode_item AND trans_in.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT reg.id_perusahaan, reg.kode_item, ( IFNULL( a.trans_out, 0 ) + IFNULL( b.trans_out, 0 ) + IFNULL( c.trans_out, 0 ) + IFNULL( d.trans_out, 0 ) + IFNULL( e.trans_out, 0 ) + IFNULL( f.trans_out, 0 ) + IFNULL( g.trans_out, 0 )) AS trans_out FROM stok_all_in_reg AS reg LEFT JOIN item AS mi ON mi.kode_item = reg.kode_item LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, COUNT( b.no_transaksi ) AS trans_out FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) a ON a.kode_item = reg.kode_item AND a.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) b ON b.kode_item = reg.kode_item AND b.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = reg.kode_item AND c.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = reg.kode_item AND d.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item, COUNT( pp.no_transaksi ) AS trans_out FROM penjualan AS p LEFT JOIN pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref WHERE pp.batal_transaksi = '0' AND pp.cetak_invoice = '1' AND pp.status_penjualan = 'penjualan' AND ias.invoice_batal = '0' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) e ON e.kode_item = reg.kode_item AND e.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT pp.id_perusahaan, p.kode_item AS kode_item, COUNT( pp.no_transaksi ) AS trans_out FROM db_wuling_sp.penjualan AS p LEFT JOIN db_wuling_sp.pesanan_penjualan AS pp ON p.id_pesanan_penjualan = pp.id_pesanan_penjualan LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON pp.no_transaksi = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = pp.no_transaksi WHERE pp.batal_transaksi = '1' AND pp.status_inbound = '1' AND ias.invoice_batal = '1' AND pp.status_penjualan = 'penjualan' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY p.kode_item, pp.id_perusahaan ) f ON f.kode_item = reg.kode_item AND f.id_perusahaan = reg.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, COUNT( msdk.no_transaksi ) AS trans_out FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS g ON g.kode_item = reg.kode_item AND g.id_perusahaan = reg.id_perusahaan WHERE reg.tipe_item = '1' AND reg.id_perusahaan = '$id_perusahaan' ) AS trans_out ON trans_out.kode_item = reg.kode_item AND trans_out.id_perusahaan = reg.id_perusahaan WHERE reg.tipe_item = '1' AND reg.id_perusahaan = '$id_perusahaan'");
        return $result;
    }

    public function getStokCurrentPUDClosingDate($id_perusahaan, $tgl_awal, $tgl_awal_bulan, $tgl_akhir_bulan = null)
    {
        $result = $this->db_wuling_sp->query("SELECT pud.id_perusahaan, pud.kode_item, pud.part_number, pud.nama_item, mi.het_now AS harga_jual, mi.class_item, IFNULL( a.stok_masuk, 0) AS masuk_pembelian, IFNULL( b.stok_ditemukan, 0) AS masuk_ditemukan, IFNULL( c.stok_masuk, 0) AS masuk_retur_service, IFNULL( d.stok_hilang, 0 ) AS keluar_hilang, IFNULL( e.stok_keluar, 0 ) AS keluar_service_new, IFNULL( f.stok_keluar, 0 ) AS keluar_service_old, IFNULL( g.stok_keluar, 0 ) AS keluar_service_retur, IFNULL( h.stok_alokasi, 0 ) AS alokasi_service, IFNULL( i.stok_wip, 0 ) AS wip_service, IFNULL( j.stok_masuk, 0 ) AS masuk_mutasi_stok, IFNULL( k.stok_keluar, 0 ) AS keluar_mutasi_stok, IFNULL( l.stok_keluar, 0 ) AS keluar_penjualan, stock_in.stok_in, stock_out.stok_out, trans_in.trans_in, trans_out.trans_out FROM stok_all_in_pud AS pud LEFT JOIN item AS mi ON mi.kode_item = pud.kode_item LEFT JOIN( SELECT imn.id_perusahaan, imn.kode_item, SUM( imn.jumlah ) AS stok_masuk FROM item_masuk_non AS imn WHERE imn.tanggal_item_masuk_non BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY imn.kode_item, imn.id_perusahaan ) a ON a.kode_item = pud.kode_item AND a.id_perusahaan = pud.id_perusahaan LEFT JOIN( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_ditemukan FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = pud.kode_item AND b.id_perusahaan = pud.id_perusahaan LEFT JOIN( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_masuk FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = pud.kode_item AND c.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_hilang FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) d ON d.kode_item = pud.kode_item AND d.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) e ON e.kode_item = pud.kode_item AND e.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) f ON f.kode_item = pud.kode_item AND f.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) g ON g.kode_item = pud.kode_item AND g.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item, SUM( wdp.qty ) AS stok_alokasi FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request != '2' AND wo.cetak_invoice != 'y' AND wo.tgl_service BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) h ON h.kode_item = pud.kode_item AND h.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item, SUM( wdp.qty ) AS stok_wip FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice != 'y' AND wo.tgl_service BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) i ON i.kode_item = pud.kode_item AND i.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, sum( msmd.stok_item_masuk ) AS stok_masuk FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS j ON j.kode_item = pud.kode_item AND j.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, SUM( msdk.stok_keluar ) AS stok_keluar FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS k ON k.kode_item = pud.kode_item AND k.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT ikn.id_perusahaan, iknd.kode_item, SUM( iknd.jumlah ) AS stok_keluar FROM item_keluar_non_detail AS iknd LEFT JOIN item_keluar_non AS ikn ON ikn.id_item_keluar_non = iknd.id_item_keluar_non WHERE ikn.tgl_item_keluar BETWEEN '$tgl_awal' AND '$tgl_awal_bulan' GROUP BY iknd.kode_item, ikn.id_perusahaan ) AS l ON l.kode_item = pud.kode_item AND l.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT pud.id_perusahaan, pud.kode_item, ( IFNULL( a.stok_masuk, 0 ) + IFNULL( b.stok_ditemukan, 0 ) + IFNULL( c.stok_masuk, 0 ) + IFNULL( d.stok_masuk, 0 ) ) AS stok_in FROM stok_all_in_pud AS pud LEFT JOIN item AS mi ON mi.kode_item = pud.kode_item LEFT JOIN ( SELECT imn.id_perusahaan, imn.kode_item, SUM( imn.jumlah ) AS stok_masuk FROM item_masuk_non AS imn WHERE imn.tanggal_item_masuk_non BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY imn.kode_item, imn.id_perusahaan ) a ON a.kode_item = pud.kode_item AND a.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_ditemukan FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = pud.kode_item AND b.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_masuk FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = pud.kode_item AND c.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, sum( msmd.stok_item_masuk ) AS stok_masuk FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS d ON d.kode_item = pud.kode_item AND d.id_perusahaan = pud.id_perusahaan WHERE pud.tipe_item = '2' AND pud.id_perusahaan = '$id_perusahaan' ) AS stock_in ON stock_in.kode_item = pud.kode_item AND stock_in.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT pud.id_perusahaan, pud.kode_item, ( IFNULL( a.stok_hilang, 0 ) + IFNULL( b.stok_keluar, 0 ) + IFNULL( c.stok_keluar, 0 ) + IFNULL( d.stok_keluar, 0 ) + IFNULL( e.stok_keluar, 0 ) + IFNULL( f.stok_keluar, 0 )) AS stok_out FROM stok_all_in_pud AS pud LEFT JOIN item AS mi ON mi.kode_item = pud.kode_item LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, SUM( bd.stok ) AS stok_hilang FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) a ON a.kode_item = pud.kode_item AND a.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) b ON b.kode_item = pud.kode_item AND b.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = pud.kode_item AND c.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, SUM( wdp.qty ) AS stok_keluar FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = pud.kode_item AND d.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, SUM( msdk.stok_keluar ) AS stok_keluar FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS e ON e.kode_item = pud.kode_item AND e.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT ikn.id_perusahaan, iknd.kode_item, SUM( iknd.jumlah ) AS stok_keluar FROM item_keluar_non_detail AS iknd LEFT JOIN item_keluar_non AS ikn ON ikn.id_item_keluar_non = iknd.id_item_keluar_non WHERE ikn.tgl_item_keluar BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY iknd.kode_item, ikn.id_perusahaan ) AS f ON f.kode_item = pud.kode_item AND f.id_perusahaan = pud.id_perusahaan WHERE pud.tipe_item = '2' AND pud.id_perusahaan = '$id_perusahaan' ) AS stock_out ON stock_out.kode_item = pud.kode_item AND stock_out.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT pud.id_perusahaan, pud.kode_item, ( IFNULL( a.trans_in, 0 ) + IFNULL( b.trans_in, 0 ) + IFNULL( c.trans_in, 0 ) + IFNULL( d.trans_in, 0 )) AS trans_in FROM stok_all_in_pud AS pud LEFT JOIN item AS mi ON mi.kode_item = pud.kode_item LEFT JOIN ( SELECT imn.id_perusahaan, imn.kode_item, COUNT( imn.kode_item_masuk_non ) AS trans_in FROM item_masuk_non AS imn WHERE imn.tanggal_item_masuk_non BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY imn.kode_item, imn.id_perusahaan ) a ON a.kode_item = pud.kode_item AND a.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, COUNT( b.no_transaksi ) AS trans_in FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '2' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) b ON b.kode_item = pud.kode_item AND b.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_in FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_retur AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = pud.kode_item AND c.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msm.id_perusahaan AS id_perusahaan, msmd.kode_item AS kode_item, COUNT( msm.no_transaksi ) AS trans_in FROM mutasi_stok_masuk_detail AS msmd LEFT JOIN mutasi_stok_masuk AS msm ON msm.id_mutasi_stok_masuk = msmd.id_mutasi_stok_masuk WHERE msm.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msmd.kode_item, msm.id_perusahaan ) AS d ON d.kode_item = pud.kode_item AND d.id_perusahaan = pud.id_perusahaan WHERE pud.tipe_item = '2' AND pud.id_perusahaan = '$id_perusahaan' ) AS trans_in ON trans_in.kode_item = pud.kode_item AND trans_in.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT pud.id_perusahaan, pud.kode_item, ( IFNULL( a.trans_out, 0 ) + IFNULL( b.trans_out, 0 ) + IFNULL( c.trans_out, 0 ) + IFNULL( d.trans_out, 0 ) + IFNULL( e.trans_out, 0 ) + IFNULL( f.trans_out, 0 )) AS trans_out FROM stok_all_in_pud AS pud LEFT JOIN item AS mi ON mi.kode_item = pud.kode_item LEFT JOIN ( SELECT b.id_perusahaan, bd.kode_item, COUNT( b.no_transaksi ) AS trans_out FROM bag_detail AS bd LEFT JOIN bag AS b ON b.id_bag = bd.id_bag WHERE b.jenis_bag = '1' AND b.CLOSE = '1' AND b.approve = '1' AND b.tgl_bag BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY bd.kode_item, b.id_perusahaan ) a ON a.kode_item = pud.kode_item AND a.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND ias.invoice_batal = '0' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND DATE( ias.invoice_date ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) b ON b.kode_item = pud.kode_item AND b.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling.buku_besar AS bb ON wdp.no_wo = bb.no_transaksi WHERE wdp.del = '0' AND wdp.s_request = '2' AND wo.cetak_invoice = 'y' AND bb.kode_akun = '110403' AND bb.dk = 'D' AND bb.journal = 'faktur_service' AND bb.jb = '0' AND bb.no_transaksi NOT LIKE '%INV-WO-CLM%' AND DATE( bb.tgl ) BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) c ON c.kode_item = pud.kode_item AND c.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT wo.id_perusahaan, wdp.kode_item AS kode_item, COUNT( wo.no_wo ) AS trans_out FROM db_wuling_as.wo_detail_part AS wdp LEFT JOIN db_wuling_as.work_order AS wo ON wdp.no_wo = wo.no_wo LEFT JOIN db_wuling_as.invoice_after_sales AS ias ON wdp.no_wo = ias.no_ref LEFT JOIN db_wuling_sp.invoice_close AS bb ON bb.no_ref = wo.no_wo WHERE wdp.del = '0' AND wo.status_inbound = '1' AND ias.invoice_batal = '1' AND ias.no_invoice NOT LIKE 'INV-WO-CLM%' AND bb.tgl BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY wdp.kode_item, wo.id_perusahaan ) d ON d.kode_item = pud.kode_item AND d.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT msdk.id_perusahaan_lokasi AS id_perusahaan, msdk.kode_item, COUNT( msdk.no_transaksi ) AS trans_out FROM mutasi_stok_detail_keluar AS msdk WHERE msdk.tgl_item_masuk BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY msdk.kode_item, msdk.id_perusahaan_lokasi ) AS e ON e.kode_item = pud.kode_item AND e.id_perusahaan = pud.id_perusahaan LEFT JOIN ( SELECT ikn.id_perusahaan, iknd.kode_item, COUNT( ikn.no_transaksi ) AS trans_out FROM item_keluar_non_detail AS iknd LEFT JOIN item_keluar_non AS ikn ON ikn.id_item_keluar_non = iknd.id_item_keluar_non WHERE ikn.tgl_item_keluar BETWEEN '$tgl_awal_bulan' AND '$tgl_akhir_bulan' GROUP BY iknd.kode_item, ikn.id_perusahaan ) AS f ON f.kode_item = pud.kode_item AND f.id_perusahaan = pud.id_perusahaan WHERE pud.tipe_item = '2' AND pud.id_perusahaan = '$id_perusahaan' ) AS trans_out ON trans_out.kode_item = pud.kode_item AND trans_out.id_perusahaan = pud.id_perusahaan WHERE pud.tipe_item = '2' AND pud.id_perusahaan = '$id_perusahaan'");
        return $result;
    }

    public function lihat_data_performa_mekanik($perusahaan, $awal, $akhir, $mekanik)
    {
        $work_order = mWorkOrder::with([
            'toUser.toKaryawan',
            'toPaket.toPaketProgress',
            'toDetailJasa' => function ($query) use ($mekanik) {
                $query->with(['toLabor', 'toHistoryProgressJasaArray'])
                    ->whereHas('toHistoryProgressJasaArray', function ($query) use ($mekanik) {
                        $query->where('id_mekanik', '=', $mekanik)->whereStatus('4');
                    })
                    ->orWhereHas('toLabor', function ($query) {
                        $query->where('db_wuling_as.wo_detail_jasa.del', '=', 0);
                    });
            }
        ])
            ->where(function ($query) use ($mekanik) {
                $query->whereHas('toUser.toKaryawan', function ($query) use ($mekanik) {
                    $query->whereId_karyawan($mekanik);
                });
                $query->orWhereHas('toDetailJasa.toHistoryProgressJasaArray', function ($query) use ($mekanik) {
                    $query->where('id_mekanik', '=', $mekanik)->whereStatus('4');
                });
            })
            ->whereBetween('tgl_service', [$awal, $akhir])
            ->whereId_perusahaan($perusahaan)
            ->whereBatal_wo('0')
            ->whereClosed('1');

        $data = $work_order->get();
        $recordsData = [];

        foreach ($data as $key => $list) {
            $detailJasa = [];
            if ($list->toPaket != null) {
                $list->toPaket->kode     = $list->toPaket->toLabor->maintenance_project_code;
                $list->toPaket->nama     = $list->toPaket->toLabor->maintenance_project_name;
                $list->toPaket->harga    = $list->toPaket->total_jasa;
                $list->toPaket->diskon   = 0;
                $list->toPaket->frt      = $list->toPaket->frt;
                $list->toPaket->is_utama = 1;
                $detailJasa[] = $list->toPaket;
            }
            // dd($detailJasa);
            foreach ($list->toDetailJasa as $jasa) {
                // dd($jasa);
                $jasa->kode   = $jasa->toLabor->maintenance_project_code ?? '-';
                $jasa->nama   = $jasa->toLabor->maintenance_project_name ?? '-';
                $jasa->harga  = $jasa->harga_jual;
                $jasa->diskon = $jasa->diskon_rp;
                $jasa->frt    = $jasa->durasi;
                $detailJasa[] = $jasa;
            }


            foreach ($detailJasa as $key1 => $value) {

                // $penerimaan  = 1;
                $noTransaksi    = self::getNoInvoice($list->no_wo);
                $namaMekanik    = self::getMekanik($mekanik);
                $lamaPengerjaan = self::getLamaPengerjaan(
                    $value->toHistoryProgressJasaArray[0]['ts_mekanik'] ?? $value->toPaketProgress[0]['mulai_mekanik'],
                    $value->toHistoryProgressJasaArray[0]['tf_mekanik'] ?? $value->toPaketProgress[0]['selesai_mekanik']
                );
                $recordsData[] = [
                    'no'            => $key1 === 0 ? $key + 1 : '',
                    'tgl_service'   => $key1 === 0 ? Carbon::parse($list->tgl_service)->format('d-m-Y') : '',
                    'nama_mekanik'  => $key1 === 0 ? $namaMekanik : '',
                    'no_wo'         => $key1 === 0 ? $list->no_wo : '',
                    'no_invoice'    => $key1 === 0 ? $noTransaksi : '',
                    // 'kode_jasa'   => $value->kode,
                    'nama_jasa'     => $value->nama,
                    'total_jasa'    => $value->total,
                    'ts_mekanik'    => $value->toHistoryProgressJasaArray[0]['ts_mekanik'] ?? $value->toPaketProgress[0]['mulai_mekanik'],
                    'tf_mekanik'    => $value->toHistoryProgressJasaArray[0]['tf_mekanik'] ?? $value->toPaketProgress[0]['selesai_mekanik'],
                    'total_jam'     => $lamaPengerjaan,
                ];
            }
        }

        return $recordsData;
    }

    private static function getNoInvoice($noWo)
    {
        $query = mBukuBesar::whereRaw('ifnull(no_ref,no_transaksi)=\'' . $noWo . '\'')
            ->whereKode_akun('110403')
            ->whereJournal('faktur_service')
            ->whereDk('D')
            ->whereJb('0');

        if ($query->count() === 0) {
            return 'Data buku besar tidak ditemukan.';
        }

        if ($query->count() === 1) {
            $value = $query->first();
            if (strpos($value->no_transaksi, 'RET-INV') === false) {
                $noTransaksi = $value->no_transaksi;
                return $noTransaksi;
            }
        }

        $noTransaksi = [];
        foreach ($query->get() as $key => $value) {
            if (strpos($value->no_transaksi, 'RET-INV') === false) {
                $noTransaksi[] = $value->no_transaksi;
            }
        }
        return $noTransaksi;
    }

    private static function getLamaPengerjaan($start, $done)
    {
        $start = new DateTime(date("Y-m-d") . " " . $start);
        $done  = new DateTime(date("Y-m-d") . " " . $done);

        $interval = date_diff($start, $done);
        if ($interval->format('%r') == "-") {
            $done->modify('+1 day');
            return date_diff($start, $done)->format('%hh %im');
        }
        return $interval->format('%hh %im');
    }

    private static function getMekanik($mekanik)
    {
        $query      = ModelKaryawan::whereId_karyawan($mekanik)->get();
        $get        = $query->first();
        $mekanik    = $get->nama_karyawan;

        if ($query == null) {
            return 'Nama mekanik tidak ditemukan';
        } else {
            return $mekanik;
        }
    }

    public function lihat_data_hutang_vendor_lokal($id_perusahaan, $tgl_awal, $tgl_akhir, $status)
    {
        $offset     = $this->request->start;

        $data = $this->db->select('hutang_vendor_lokal.*,vendor_master.nama,pengeluaranOperasional.no_pengeluaran,pengeluaranOperasional.no_bukti_bku,pengeluaranOperasional.jumlah')->from('db_wuling_as.hutang_vendor_lokal')->join('db_wuling_as.vendor_master', 'vendor_master.id=hutang_vendor_lokal.id_vendor')->join("(SELECT pengeluaran_operasional_detail.*,pengeluaran_operasional.no_bukti_bku FROM db_wuling.pengeluaran_operasional_detail JOIN db_wuling.pengeluaran_operasional ON pengeluaran_operasional.no_pengeluaran=pengeluaran_operasional_detail.no_pengeluaran WHERE (pengeluaran_operasional.approved='0' OR (pengeluaran_operasional.approved='1' AND EXISTS (SELECT*FROM db_wuling.buku_besar WHERE no_transaksi=pengeluaran_operasional.no_bukti_bku AND jb='0' LIMIT 1))) AND pengeluaran_operasional.hapus='0') AS pengeluaranOperasional", 'pengeluaranOperasional.no_ref=hutang_vendor_lokal.no_po', 'left')->where("hutang_vendor_lokal.id_perusahaan=$id_perusahaan AND hutang_vendor_lokal.tanggal BETWEEN '$tgl_awal' AND '$tgl_akhir' AND hutang_vendor_lokal.status='0'")->where($status === 0 ? 'pengeluaranOperasional.no_bukti_bku IS NULL' : 'pengeluaranOperasional.no_bukti_bku IS NOT NULL')->get();

        $noPo = [];
        foreach ($data->result() as $key => $value) {
            $noPo[] = $value->no_po;
        }

        if (count($noPo) > 0) {
            $toBukuBesar = $this->db->from('db_wuling.buku_besar')->where_in('no_transaksi', $noPo)->get()->result();
        }

        foreach ($data->result() as $key => $value) {
            $bukuBesar = [];
            foreach ($toBukuBesar as $key1 => $value1) {
                if ($value1->no_transaksi === $value->no_po) {
                    $bukuBesar[] = $value1;
                }
            }
            $value->toBukuBesar = $bukuBesar;
        }

        $recordsData = [];
        foreach ($data->result() as $key => $value) {
            $harga = $ppn = $total = 0;
            foreach ($value->toBukuBesar as $key1 => $value1) {
                if ($value1->kode_akun === '110890') {
                    $harga = $value1->jumlah;
                }
                if ($value1->kode_akun === '110905') {
                    $ppn = $value1->jumlah;
                }
                if ($value1->kode_akun === '210202') {
                    $total = $value1->jumlah;
                }
            }
            $nilaiHutang = $total;
            if (!empty($value->no_bukti_bku)) {
                $nilaiHutang =  $total - $value->jumlah;
            }
            $recordsData[] = [
                'no'             => $offset + $key + 1,
                'tanggal'        => $value->tanggal,
                'no_po'          => $value->no_po,
                'no_wo'          => $value->no_ref,
                'no_pengeluaran' => $value->no_pengeluaran ?? '-',
                'no_bukti_bku'   => $value->no_bukti_bku ?? '-',
                'nama_vendor'    => $value->nama,
                'harga'          => separator_harga($harga),
                'ppn'            => separator_harga($ppn),
                'total'          => separator_harga($total),
                'hutang'         => separator_harga($nilaiHutang),
            ];
        }

        $sumQuery = $this->db->select("SUM(CASE WHEN buku_besar.kode_akun='110890' AND buku_besar.dk='D' THEN buku_besar.jumlah ELSE 0 END) AS totalHarga,SUM(CASE WHEN buku_besar.kode_akun='110905' AND buku_besar.dk='D' THEN buku_besar.jumlah ELSE 0 END) AS totalPpn,SUM(CASE WHEN buku_besar.kode_akun='210202' AND buku_besar.dk='K' THEN buku_besar.jumlah ELSE 0 END) AS total,SUM(CASE WHEN buku_besar.kode_akun='210202' AND buku_besar.dk='K' THEN pengeluaranOperasional.jumlah ELSE 0 END) AS totalHutang")->from('db_wuling.buku_besar')->join("(SELECT pengeluaran_operasional_detail.*,pengeluaran_operasional.no_bukti_bku FROM db_wuling.pengeluaran_operasional_detail JOIN db_wuling.pengeluaran_operasional ON pengeluaran_operasional.no_pengeluaran=pengeluaran_operasional_detail.no_pengeluaran WHERE pengeluaran_operasional.approved='1' AND EXISTS (SELECT*FROM db_wuling.buku_besar WHERE no_transaksi=pengeluaran_operasional.no_bukti_bku AND jb='0' LIMIT 1) AND pengeluaran_operasional.hapus='0') AS pengeluaranOperasional", 'pengeluaranOperasional.no_ref=buku_besar.no_transaksi', 'left')->where("journal='pembelian_sublet' AND jb='0' AND id_perusahaan=$id_perusahaan AND tgl BETWEEN '$tgl_awal' AND '$tgl_akhir'")->where($status === 0 ? "pengeluaranOperasional.no_bukti_bku IS NULL" : "pengeluaranOperasional.no_bukti_bku IS NOT NULL")->get()->row();

        $summary = [
            'totalHarga'  => separator_harga($sumQuery->totalHarga),
            'totalPpn'    => separator_harga($sumQuery->totalPpn),
            'total'       => separator_harga($sumQuery->total),
            'totalHutang' => separator_harga($sumQuery->total - $sumQuery->totalHutang),
        ];

        $hasil = [
            'data' => $recordsData,
            'summary' => $summary
        ];

        return $hasil;
    }
}
